<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js"></script>
<script>
	WebAudioControlsOptions = {
		useMidi: 1,
	};
</script>

<style>
	@font-face {
		font-family: 'metalfont';
		src: url('./assets/metalfont.ttf') format('truetype');
		font-weight: normal;
		font-style: normal;

	}
</style>

<script src="./../../../bower_components/webaudio-controls2/webaudio-controls.js"></script>
<template id="metalmachine">

	<style>
		:host {
			background-color: rgb(255, 255, 255);
			font: 'metalfont', 'Arial Black';
			display: block;
			width: 550px;
			height: 150px;
			user-select: none;
			border-radius: 10px;
			position: relative;
			z-index: 9;
			/* bring your own prefixes */
			box-shadow: 4px 5px 6px rgba(0, 0, 0, 0.7),
				inset -2px -2px 5px 0px rgba(0, 0, 0, 0.2),
				inset 3px 1px 1px 4px rgba(255, 255, 255, 0.2),
				1px 0px 1px 0px rgba(0, 0, 0, 0.9),
				0 2px 1px 0 rgba(0, 0, 0, 0.9),
				1px 1px 1px 0px rgba(0, 0, 0, 0.9);
		}

		.webaudioctrl-tooltip {
			color: #000 !important;
			font-family: "Arial Black" !important;
			font-size: 11px !important;
		}


		#background-image {
			width: 550px;
			height: 150px;
			opacity: 1;

			box-shadow: 4px 5px 6px rgba(0, 0, 0, 0.7),
				inset -2px -2px 5px 0px rgba(0, 0, 0, 0.2),
				inset 3px 1px 1px 4px rgba(255, 255, 255, 0.2),
				1px 0px 1px 0px rgba(0, 0, 0, 0.9),
				0 2px 1px 0 rgba(0, 0, 0, 0.9),
				1px 1px 1px 0px rgba(0, 0, 0, 0.9);
		}

		.knob,
		.switch,
		.icon,
		.label {
			position: absolute;
			cursor: pointer;
		}

		#switch1 {
			bottom: 20px;
			right: 10px;
		}

		#switchpreamp {
			top: 25px;
			left: 425px;
		}

		#preampswitchlabel {
			color: #ffffff;
			font-family: "metalfont";
			font-size: 15px;
			top: 60px;
			left: 435px;
		}

		#switchfilter {
			top: 25px;
			left: 470px;
		}

		#filterswitchlabel {
			color: #ffffff;
			font-family: "metalfont";
			font-size: 15px;
			top: 60px;
			left: 480px;
		}


		#presence {
			left: 375px;
			top: 20px;
		}

		#presence div {
			color: #ffffff;
			font-family: "metalfont";
			font-size: 15px;

		}


		#reverb {
			left: 325px;
			top: 20px;
		}

		#reverb div {
			color: #ffffff;
			font-family: "metalfont";
			font-size: 15px;

		}

		#treble {
			left: 275px;
			top: 20px;
		}

		#treble div {
			color: #ffffff;
			font-family: "metalfont";
			font-size: 15px;

		}

		#middle {
			left: 225px;
			top: 20px;
		}

		#middle div {
			color: #ffffff;
			font-family: "metalfont";
			font-size: 15px;

		}

		#bass {
			left: 175px;
			top: 20px;
		}

		#bass div {
			color: #ffffff;
			font-family: "metalfont";
			font-size: 15px;

		}

		#drive {
			left: 125px;
			top: 20px;
		}

		#drive div {
			color: #ffffff;
			font-family: "metalfont";
			font-size: 15px;

		}

		#master {
			left: 75px;
			top: 20px;
		}

		#master div {
			color: #ffffff;
			font-family: "metalfont";
			font-size: 15px;

		}

		#volume {
			left: 25px;
			top: 20px;
		}

		#volume div {
			color: #ffffff;
			font-family: "metalfont";
			font-size: 15px;

		}

		#label_713 {

			left: 220px;
			top: 95px;
			color: #f8f8f8;
			font-family: "metalfont";
			font-size: 40px;
		}

		#menuPresets {
			border-style: solid;
			border-width: 2px;
			border-color: #000000;
			background-color: rgb(255, 254, 254);
			position: absolute;
			width: 100px;
			left: 30px;
			top: 100px;
			color: #000000;
			font-family: "Arial Black";
			font-size: 12px;
		}
	</style>
	<img id="background-image">

	<div class="switchCont" id="switch1">
		<webaudio-switch class="switch" id="switch1" height="30" width="60"></webaudio-switch>
	</div>
	<div class="switch" id="switchpreamp">
		<webaudio-switch class="switch" height="30" width="60"></webaudio-switch>
	</div>
	<div id="preampswitchlabel" class="label">Bleedy</div>

	<div class="switch" id="switchfilter">
		<webaudio-switch class="switch" height="30" width="60" value=1></webaudio-switch>
	</div>
	<div id="filterswitchlabel" class="label">Smooth</div>


	<div class="knob " id="presence">
		<webaudio-knob height="40" width="40" sprites="100" min="0" max="10" step="0.1" value="5" midilearn="1"></webaudio-knob>
		<div style="text-align:center">Presence</div>
	</div>
	<div class="knob  " id="reverb">
		<webaudio-knob height="40" width="40" sprites="100" min="0" max="10" step="0.1" value="0.3" midilearn="1"></webaudio-knob>
		<div style="text-align:center">Reverb</div>
	</div>
	<div class="knob " id="treble">
		<webaudio-knob height="40" width="40" sprites="100" min="0" max="10" step="0.1" value="3.9" midilearn="1"></webaudio-knob>
		<div style="text-align:center">Treble</div>
	</div>
	<div class="knob " id="middle">
		<webaudio-knob height="40" width="40" sprites="100" min="0" max="10" step="0.1" value="8.2" midilearn="1"></webaudio-knob>
		<div style="text-align:center">Middle</div>
	</div>
	<div class="knob " id="bass">
		<webaudio-knob height="40" width="40" sprites="100" min="0" max="10" step="0.1" value="8.7" midilearn="1"></webaudio-knob>
		<div style="text-align:center">Bass</div>
	</div>
	<div class="knob " id="drive">
		<webaudio-knob height="40" width="40" sprites="100" min="0" max="10" step="0.1" value="5.3" midilearn="1"></webaudio-knob>
		<div style="text-align:center">Drive</div>
	</div>
	<div class="knob " id="master">
		<webaudio-knob height="40" width="40" sprites="100" min="0" max="10" step="0.1" value="7" midilearn="1"></webaudio-knob>
		<div style="text-align:center">Master</div>
	</div>
	<div class="knob " id="volume">
		<webaudio-knob height="40" width="40" sprites="100" min="0" max="10" step="0.1" value="6.5" midilearn="1"></webaudio-knob>
		<div style="text-align:center">Volume</div>
	</div>
	<select id="menuPresets">
		<option value=0>Default</option>
		<option value=1>Metal 1</option>
		<option value=2>Metal 5</option>
		<option value=3>Iron Maiden</option>
		<option value=4>Black Sabbath</option>
		<option value=5>Clean 1</option>
		<option value=6>Clean with little crunch</option>
		<option value=7>Heavy Blues</option>
	</select>
	<div class="label" id="label_713">Metal Machine</div>
</template>
<script>
	let MetalMachineTemp = document.currentScript.ownerDocument.querySelector('#metalmachine');
	class MetalMachineGui extends HTMLElement {


		constructor(plug) {

			super();
			this._plug = plug;
			this._plug.gui = this;
			this._root = this.attachShadow({
				mode: 'open'
			});
			this._root.appendChild(MetalMachineTemp.content.cloneNode(true));
			this.knobs = this._root.querySelectorAll(".knob");
			this.isOn;
			this.state = new Object();
			this.menu = this._root.querySelector("#menuPresets");
			this.index = this.menu.value;
			this.setKnobs();
			this.setSwitchListener();
			this.setResources();
			this.avoidDrag();
		}

		get properties() {

			this.boundingRect = {
				dataWidth: {
					type: Number,
					value: 550
				},
				dataHeight: {
					type: Number,
					value: 150
				}
			};
			return this.boundingRect;

		}

		static get observedAttributes() {

			return ['state'];

		}

		attributeChangedCallback() {
			this.state = JSON.parse(this.getAttribute('state'));
			console.log(this.state);
			if (this.state.status == "enable") {
				this._root.querySelector("#switch1").querySelector("webaudio-switch").value = 1;
				this.isOn = true;
			}
			console.log(this.state.preampPos);
			if (this.state.preampPos == "after") {
				this._root.querySelector("#switchpreamp").querySelector("webaudio-switch").value = 1;

			} else {
				this._root.querySelector("#switchpreamp").querySelector("webaudio-switch").value = 0;
			}
			if (this.state.filterstate === true) {
				this._root.querySelector("#switchfilter").querySelector("webaudio-switch").value = 1;
			} else {
				this._root.querySelector("#switchfilter").querySelector("webaudio-switch").value = 0;
			}
			this.knobs = this._root.querySelectorAll(".knob");
			for (var i = 0; i < this.knobs.length; i++) {
				this.knobs[i].querySelector("webaudio-knob").setValue(this.state[this.knobs[i].id], false);
			}
			if (this.state.preset) {
				console.log("changepresetgui");
				var preset = this._root.querySelector("#menuPresets");
				preset.value = this.state.preset;
			}



		}
		setResources() {
			let menuPresets = this._root.querySelector("#menuPresets");
			menuPresets.onchange = (e) => {
				this.index = e.target.value;
				this._plug.setParam("preset", this.index);
				//this._plug.setPatch(null, this.index);
			}
			// Set up the background img & style
			var background = this._root.querySelector("img");
			background.src = this._plug.URL + '/assets/MetalMachine.png';
			background.style = 'border-radius :10px;'
			// Setting up the knobs imgs, those are loaded from the assets
			this._root.querySelectorAll(".knob").forEach((knob) => {
				knob.querySelector("webaudio-knob").setAttribute('src', this._plug.URL + '/assets/Jambalaya.png');
			});
			// Setting up the switches imgs, those are loaded from the assets
			this._root.querySelector("#switch1").querySelector("webaudio-switch").setAttribute('src', this._plug.URL +
				'/assets/switch_2.png');
			this._root.querySelector("#switchpreamp").querySelector("webaudio-switch").setAttribute('src', this._plug.URL +
				'/assets/switch_2.png');
			this._root.querySelector("#switchfilter").querySelector("webaudio-switch").setAttribute('src', this._plug.URL +
				'/assets/switch_2.png');

		}

		eventToKnob(rank) {
			// bind knobs to a _plug param by its id
			this.knobs[rank].querySelector("webaudio-knob").addEventListener('input', (e) =>
				this._plug.setParam(this.knobs[rank].id, e.target.value));
		}

		setKnobs() {
			// Loop on a function to get the real id at each steps
			for (var i = 0; i < this.knobs.length; i++) {
				this.eventToKnob(i);
			}
			console.log(this._root.querySelector("#switchpreamp").querySelector("webaudio-switch"));
			this._root.querySelector("#switchpreamp").querySelector("webaudio-switch").addEventListener('change', (e) => this._plug
				.setParam("preampPos", e.target.value));
			this._root.querySelector("#switchfilter").querySelector("webaudio-switch").addEventListener('change', (e) => this._plug
				.setParam("filterstate", e.target.value));
		}


		bypass() {
			// bypass the plug
			this._plug.setParam("status", "disable");
		}


		reactivate() {
			// reactivate the plug
			this._plug.setParam("status", "enable");
		}

		setSwitchListener() {
			// set the GUI switch state and call the plug bypass / reactivation
			this._root.querySelector("#switch1").querySelector("webaudio-switch").addEventListener('change', (e) => {
				if (this.isOn) this.bypass()
				else this.reactivate();
				this.isOn = !this.isOn;
			});
		}

		avoidDrag() {
			this._root.querySelector("#background-image").draggable = false;
		}

	}
	try {
		customElements.define('wasabi-metalmachine', MetalMachineGui);
		console.log("Element defined");
	} catch (error) {
		console.log(error);
		console.log("Element already defined");
	}
	createMetalMachine = (plug) => {
		let elem = new MetalMachineGui(plug);
		return elem;
	}
</script>