<!-- Imports -->

<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js"></script>
<script> WebAudioControlsOptions = { useMidi: 1 }; </script>
<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webaudio-controls.js"></script>

<template id="wc-stereoflanger">

	<style>
		:host {
			background: linear-gradient( rgb(77, 74, 78), rgb(136, 5, 129));
			box-shadow: 4px 5px 6px rgba(0, 0, 0, 0.7),
			inset -2px -2px 5px 0px rgba(0, 0, 0, 0.2),
			inset 3px 1px 1px 4px rgba(255, 255, 255, 0.2),
			1px 0px 1px 0px rgba(0, 0, 0, 0.9),
			0 2px 1px 0 rgba(0, 0, 0, 0.9),
			1px 1px 1px 0px rgba(0, 0, 0, 0.9);

			width: 120px;
			height: 180px;
			display: block;
			user-select: none;
			cursor: move;
			z-index: 9;

			border-bottom-left-radius: 8px;
			border-bottom-right-radius: 8px;
		}

		.pedalLabel,
		.div_buttons {
			border-radius: 8px;
		}

		.div_menuPanel {
			/* border-top-left-radius: 8px;border-top-right-radius: 8px; */
		}

		webaudio-switch {
			left: -6px;
		}

		.pedalLabel {
			/* background: rgba(0, 0, 0, 0.4); */
			box-shadow: inset 0px 1px 5px #111;
			border: 1px solid #ccc;
			color: #ccc;
			/* border:2px solid #aaa; */
			padding: 4px 10px;
			margin: 2px 0px;

			font-size: 10px;
			text-align: center;
			user-select: none;
			/* font-family: Lemon\/Milk; */
			font-family: helvetica;
			text-transform: uppercase;
		}

		.knob-label {
			color: #ddd;
			text-shadow: 0px 1px 1px #000;

			font-size: 6px;
			margin-top: -2px;

			text-align: center;
			text-transform: uppercase;
			overflow: hidden;
			user-select: none;
			font-family: helvetica;
		}

		.elements {
			display: flex;
			flex-direction: column;
			justify-content: flex-start;
			align-items: center;

			padding: 10px;
		}

		.column {
			display: flex;
			flex-direction: column;
			justify-content: flex-start;
			align-items: center;

			flex: 1;
			margin: 3px;
		}

		.row {
			display: flex;
			flex-direction: row;
			justify-content: flex-start;
			align-items: stretch;
		}
	</style>

	<div class="row">

		<div class="column">

			<webaudio-knob id="knob1" class="knob" sprites="99" min="0" max="1" step="0.01" value="0.9" midilearn="true" src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/img/nux_black_white_stripe.png"
			 width="40" height="40" data-role="feedback" diameter="24"></webaudio-knob>
			<span class="knob-label" id="knob1-label">FEEDBACK</span>

		</div>
		<div class="column">

			<webaudio-knob id="knob2" class="knob" sprites="99" min="0.001" max="0.02" step="0.0001" value="0.003" midilearn="true" src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/img/nux_black_white_stripe.png"
			 width="40" height="40" data-role="delay" diameter="24"></webaudio-knob>
			<span class="knob-label" id="knob2-label">DELAY</span>

		</div>

	</div>

	<div class="row">

		<div class="column">

			<webaudio-knob id="knob3" class="knob" sprites="99" min="0.0005" max="0.02" step="0.00025" value="0.005" midilearn="true"
			 src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/img/nux_black_white_stripe.png" width="40" height="40" data-role="depth"
			 diameter="24"></webaudio-knob>
			<span class="knob-label" id="knob3-label">DEPTH</span>

		</div>
		<div class="column">

			<webaudio-knob id="knob4" class="knob" sprites="99" min="0.05" max="2" step="0.05" value="0.15" midilearn="true" src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/img/nux_black_white_stripe.png"
			 width="40" height="40" data-role="frequency" diameter="24"></webaudio-knob>
			<span class="knob-label" id="knob3-label">FREQUENCY</span>

		</div>

	</div>

	<div class="row">

		<div class="column">

			<webaudio-switch id="switch1" class="switch" midilearn="true" src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/img/switch_1.png"
			 width="32" height="20"></webaudio-switch>

		</div>

	</div>

	<div class="row">

		<div class="column">

			<span class="pedalLabel">Stereo Flanger</span>

		</div>

	</div>

</template>

<script>

	let stftmp = document.currentScript.ownerDocument.querySelector("#wc-stereoflanger");

	class StereoFlangerGUI extends HTMLElement {
		constructor(plug) {
			super();
			this._plug = plug;
			this._plug.gui = this;
			this._root = this.attachShadow({ mode: 'open' });
			this._root.appendChild(stftmp.content.cloneNode(true));
			this.isOn = false;
			this.state = new Object();
			this.setKnobs();
			this.setSwitchListener();
		}

		get properties() {
			this.boundingRect =
				{
					dataWidth:
					{
						type: Number,
						value: 120
					},
					dataHeight:
					{
						type: Number,
						value: 180
					}
				};

			return this.boundingRect;
		}

		static get observedAttributes() { return ['state']; }

		attributeChangedCallback() {
			console.log(`Custom element ${this.is} attributes changed.`);
			this.state = JSON.parse(this.getAttribute('state'));
			console.log(this.state);
			if (this.state.status == "enable") {
				this._root.querySelector("#switch1").value = 1;
				this.isOn = true;
			}else{
        this._root.querySelector("#switch1").value = 0;
        this.isOn = false;
      }
			this.knobs = this._root.querySelectorAll(".knob");
			this.labels = this._root.querySelectorAll(".knob-label");

			for (var i = 0; i < this.knobs.length; i++) {
				this.knobs[i].value = this.state[this.labels[i].innerHTML.toLowerCase().replace(/ /g, "")];
			}
			console.log(this.knobs);

		}

		setKnobs() {
			this._root.querySelector("#knob1").addEventListener('input', (e) => this._plug.setParam("feedback", e.target.value));
			this._root.querySelector("#knob2").addEventListener('input', (e) => this._plug.setParam("delay", e.target.value));
			this._root.querySelector("#knob3").addEventListener('input', (e) => this._plug.setParam("depth", e.target.value));
			this._root.querySelector("#knob4").addEventListener('input', (e) => this._plug.setParam("frequency", e.target.value));
		}

		setSwitchListener() {
      console.log("setswitch");
      this._root.querySelector("#switch1").addEventListener('change', (e) => {
        if (this.isOn) this.bypass()
        else this.reactivate();
        this.isOn = !this.isOn;
      });
    }

    bypass() {
      this._plug.setParam("status", "disable");
    }
    reactivate() {
      this._plug.setParam("status", "enable");
    }
	}
	// Register the x-custom element with the browser

	try {
		console.log("Element defined");
		customElements.define('wasabi-stereoflanger', StereoFlangerGUI);
	}
	catch (error) {
		console.log(error);
		console.log("Element already defined");
	}

	createStereoFlanger = (plug) => {
		let elem = new StereoFlangerGUI(plug);
		return elem;
	}
</script>