<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webcomponents-lite.js"></script>
<script>
  WebAudioControlsOptions = {
    useMidi: 1,
  };
</script>
<script src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/bower_components/webaudio-controls2/webaudio-controls.js"></script>
<template id="wc-wahvox">
  <style>
    :host {
      background: linear-gradient( rgb(228, 215, 233), rgb(226, 212, 206));
      box-shadow: 4px 5px 6px rgba(0, 0, 0, 0.7), inset -2px -2px 5px 0px rgba(0, 0, 0, 0.2), inset 3px 1px 1px 4px rgba(255, 255, 255, 0.2), 1px 0px 1px 0px rgba(0, 0, 0, 0.9), 0 2px 1px 0 rgba(0, 0, 0, 0.9), 1px 1px 1px 0px rgba(0, 0, 0, 0.9);


      width: 180px;
      height: 220px;
      display: block;
      user-select: none;
      cursor: move;
      z-index: 9;

      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    .pedalLabel,
    .div_buttons {
      border-radius: 8px;
    }

    .div_menuPanel {
      /* border-top-left-radius: 8px;
        border-top-right-radius: 8px; */
    }

    webaudio-switch {
      left: -6px;

    }

    .pedalLabel {
      /* background: rgba(0, 0, 0, 0.4); */
      box-shadow: inset 0px 1px 5px #111;
      border: 1px solid #ccc;
      color: rgb(204, 204, 204);
      padding: 4px 10px;

      font-size: 10px;
      text-align: center;
      user-select: none;
      font-family: helvetica;
      text-transform: uppercase;
      margin-top: 20px;
    }

    .knob-label {
      color: rgb(255, 255, 255);
      text-shadow: 0px 1px 1px #000;

      font-size: 9px;
      margin-top: -2px;

      text-align: center;
      text-transform: uppercase;
      overflow: hidden;
      user-select: none;
      font-family: helvetica;
      margin-top: 5px;

    }

    .elements {
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: center;

      padding: 10px;

    }

    .column {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      background-color: black;
      flex: 1;
      margin: 3px;
      margin-top: 10px;
      border-radius: 5px;
    }

    .column2 {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      flex: 1;
      margin: 3px;
      margin-top: 10px;
      border-radius: 5px;
    }

    .row {
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: stretch;

    }
  </style>
  <div class="row">
    <div class="column">
      <webaudio-slider id="masterSlider" midilearn="true" units="Db" src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/jordan-SINTES/wah_effect/WahVox/image/vsliderbody.png"
        knobsrc="https://wasabi.i3s.unice.fr/WebAudioPluginBank/jordan-SINTES/wah_effect/WahVox/image/vsliderknob.png" value="50"
        min="0" max="100" step="1" basewidth="24" height="128" knobwidth="24" knobheight="24" ditchlength="100" oncontextmenu="return false;"
        defvalue="2" tooltip="Effect" data-role="effect" midicc="1.7">

        <div class="webaudio-slider-body" tabindex="1" touch-action="none" style="background-size: 100% 100%; width: 24px; height: 128px; background-image: url(https://wasabi.i3s.unice.fr/WebAudioPluginBank/Mike-AUBENAS/MixingConsole/ChannelMixer/Image/vsliderbody.png); outline: none;">
          <div class="webaudio-slider-knob" touch-action="none" style="background-size: 100% 100%; width: 24px; height: 24px; background-image: url(https://wasabi.i3s.unice.fr/WebAudioPluginBank/Mike-AUBENAS/MixingConsole/ChannelMixer/Image/vsliderknob.png); left: 0px; top: 50px;">
          </div>
        </div>
        <div class="webaudioctrl-tooltip" style="display: inline-block; width: auto; height: auto; transition: opacity 0.1s 0s, visibility 0.1s 0s; opacity: 0; visibility: hidden; left: 976.234px; top: -33px;">Slider1 : 0
        </div>

      </webaudio-slider>
      <span class="knob-label" id="knob1-label">EFFECT</span>
      <webaudio-switch id="switch1" class="switch" midilearn="true" src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/img/switch_1.png"
        width="32" height="20"></webaudio-switch>
      <span class="pedalLabel">Vox V847</span>
    </div>
    <div class="column2">
      <webaudio-switch id="switch2" class="switch" midilearn="true" src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/img/switch_1.png"
        width="32" height="20"></webaudio-switch>
      <span class="knob-label" id="knob1-label">BOOST</span>
      <div class="row">
        <webaudio-slider class="knob" id="mode" midilearn="1" midicc="2.0" value="1" min="1" max="3" step="1" width="15" height="34"
          tooltip="Mode"></webaudio-slider>
      </div>

      <span class="knob-label" id="knob1-label">Mode</span>

      <webaudio-knob id="knob" class="knob" sprites="99" min="1" max="5" step="1" value="3" midilearn="true" src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/img/nux_black_white_stripe.png"
        width="30" height="30" data-role="frequency" diameter="24" tooltip="Frequency"></webaudio-knob>
      <span class="knob-label" id="knob3-label">FREQUENCY</span>

      <webaudio-knob id="knob2" class="knob" sprites="99" min="1" max="5" step="1" value="3" midilearn="true" src="https://wasabi.i3s.unice.fr/WebAudioPluginBank/img/nux_black_white_stripe.png"
        width="30" height="30" data-role="frequency" diameter="24" tooltip="Q Factor"></webaudio-knob>
      <span class="knob-label" id="knob3-label">Q FACTOR</span>
    </div>
  </div>
</template>
<script>
  let wahtemp = document.currentScript.ownerDocument.querySelector("#wc-wahvox");
  class WahVoxGUI extends HTMLElement {

    constructor(plug) {
      super();
      this._plug = plug;
      this._plug.gui = this;
      this._root = this.attachShadow({ mode: 'open' });
      this._root.appendChild(wahtemp.content.cloneNode(true));
      this.knobs = this._root.querySelectorAll(".knob");
      this.mode = this._root.querySelectorAll(".mode");
      this.isOn;
      this.isOnBoost;
      this.state = new Object();
      this.setKnobs();
      this.setSwitchListener();
      this.setBoostListener();
    }

    get properties() {
      this.boundingRect = {
        dataWidth: {
          type: Number,
          value: 180
        },
        dataHeight: {
          type: Number,
          value: 220
        }
      };
      return this.boundingRect;
    }

    static get observedAttributes() { return ['state']; }

    attributeChangedCallback() {
      this.state = JSON.parse(this.getAttribute('state'));
      console.log(this.state);
      if (this.state.status == "enable") {
        this._root.querySelector("#switch1").value = 1;
        this.isOn = true;
      }

      if (this.state.boost == "enable") {
        this._root.querySelector('#switch2').value = 1;
        this.isOnBoost = true;
      }
      this.knobs = this._root.querySelectorAll(".knob");
      this._root.querySelector("#mode").setValue(this.state["mode"], false);
      this._root.querySelector("#knob").setValue(this.state["frequency"], false);
      this._root.querySelector("#knob2").setValue(this.state["qfactor"], false);
      this._root.querySelector("#masterSlider").setValue(this.state["effect"], false);

    }

    setKnobs() {
      console.log('setknobs');
      this._root.querySelector("#masterSlider").addEventListener('input', (e) => this._plug.setParam("effect", e.target.value));
      this._root.querySelector("#mode").addEventListener('input', (e) => this._plug.setParam("mode", e.target.value));
      this._root.querySelector("#knob").addEventListener('input', (e) => this._plug.setParam("frequency", e.target.value));
      this._root.querySelector("#knob2").addEventListener('input', (e) => this._plug.setParam("qfactor", e.target.value));
    }

    setSwitchListener() {
      console.log("setswitch");
      this._root.querySelector("#switch1").addEventListener('change', (e) => {
        if (this.isOn) this.bypass();
        else this.reactivate();
        this.isOn = !this.isOn;
      });
    }

    bypass() {
      this._plug.setParam("status", "disable");
    }
    reactivate() {
      this._plug.setParam("status", "enable");
    }

    setBoostListener() {
      console.log("setBoost");
      this._root.querySelector("#switch2").addEventListener('change', (e) => {
        if (this.isOnBoost) this.bypassBoost();
        else this.reactivateBoost();
        this.isOnBoost = !this.isOnBoost;
      });
    }

    bypassBoost() {
      this._plug.setParam("boost", "disable");
    }
    reactivateBoost() {
      this._plug.setParam("boost", "enable");
    }

  }
  
  // Register the x-custom element with the browser
  try {
    console.log("Element defined");
    customElements.define('wasabi-wahvox', WahVoxGUI);
  } catch (error) {
    console.log(error);
    console.log("Element already defined");
  }

  createWahVox = (plug) => {
    let elem = new WahVoxGUI(plug);
    return elem;
  }
</script>